<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Geant4: Example ThreadsafeScorers</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Geant4
   &#160;<span id="projectnumber">10.05.p01</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Example ThreadsafeScorers </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This example demonstrates a very simple application where an energy deposit and # of steps is accounted in thread-local (i.e. one instance per thread) hits maps with underlying types of plain-old data (POD) and global (i.e. one instance) hits maps with underlying types of atomics. The example uses a coarse mesh, extensive physics, and step limiters to ensure that there is a higher degree of conflict between threads when updating the scorers to test the robustness of the atomics classes and maximize the compounding of thread-local round-off error.</p>
<p>At the end of the simulation, the scorers are printed to "mfd_&lt;DATA_TYPE&gt;_&lt;SCORER_TYPE&gt;.out", where DATA_TYPE is either "tl" (thread-local) or "tg" (thread-global) and SCORER_TYPE is "EnergyDeposit" or "NumberOfSteps". These values are then compared to a thread-global sum of these scorers that were updated via mutex locking. If round-off errors in thread-local EnergyDeposit are present, they can be viewed in "mfd_diff.out" at the end of the simulation</p>
<p>This example also provides a demonstration of the TiMemory (timing and memory analysis) package provided in Geant4 &ndash; for documentation of TiMemory see <a href="https://github.com/jrmadsen/TiMemory">https://github.com/jrmadsen/TiMemory</a>.</p>
<h1><a class="anchor" id="ThreadsafeScorers_s1"></a>
ATOMICS and the ATOMIC SCORERS</h1>
<p>atomics can ONLY handle plain-old data (POD) types, e.g. int, double, etc. The implementation of atomics in compiler-dependent. At the very worst, the performance of an atomic is the same mutex locking. Atomics, in general, are not copy-constructable. This has to do with thread safety (e.g. making a copy while another thread tries to update) This is why atomics cannot be used in STL containers. The implementation in atomic.hh has limited copy-construction and still cannot be used in STL containers. Use these copy-constructors with extreme caution. See opening comments of <a class="el" href="../../d2/d15/G4atomic_8hh.html" title="Definition of the G4atomic class.">G4atomic.hh</a> for more details.</p>
<p>The newly provided classes in this example (G4atomic, <a class="el" href="../../d0/d0b/classG4TAtomicHitsMap.html" title="This is an implementation of G4THitsMap&lt;T&gt; where the underlying type is G4atomic&lt;T&gt;,...">G4TAtomicHitsMap</a>, and <a class="el" href="../../d9/dc6/classG4TAtomicHitsCollection.html" title="This is an implementation of G4THitsCollection&lt;T&gt; where the underlying type is G4atomic&lt;T&gt;,...">G4TAtomicHitsCollection</a>) are intended for applications where memory is a greater concern than performance. While atomics generally perform better than mutex locking, the synchronization is not without a cost. However, since the memory consumed by thread-local hits maps scales roughly linearly with the number of threads, simulations with a large number of scoring volumes can decrease simulation time by increasing the number of threads beyond what was previously allowed due to the increase in memory consumption. </p><pre class="fragment">These classes are intended to be included in the Geant4 source code ***
release next year                                                   ***
</pre><p>The <a class="el" href="../../d0/d0b/classG4TAtomicHitsMap.html" title="This is an implementation of G4THitsMap&lt;T&gt; where the underlying type is G4atomic&lt;T&gt;,...">G4TAtomicHitsMap</a> and <a class="el" href="../../d9/dc6/classG4TAtomicHitsCollection.html" title="This is an implementation of G4THitsCollection&lt;T&gt; where the underlying type is G4atomic&lt;T&gt;,...">G4TAtomicHitsCollection</a> work exactly the same way as the standard <a class="el" href="../../d7/d42/classG4THitsMap.html">G4THitsMap</a> and <a class="el" href="../../d5/d58/classG4THitsCollection.html">G4THitsCollection</a>, respectively, with the exception(s) that you should only implement one instance and provide a pointer/reference of that instance to the threads instead of having the threads create them. Additionally, there is no need to include them in the <a class="el" href="../../d2/d10/classG4Run.html#a83fad19c4a64f0e0888743b3063eaba8">G4Run::Merge()</a>.</p>
<h1><a class="anchor" id="ThreadsafeScorers_s2"></a>
GEOMETRY DEFINITION</h1>
<p>The geometry is constructed in the <a class="el" href="../../d7/dfa/classTSDetectorConstruction.html">TSDetectorConstruction</a> class. The setup consists of a box filling the world. The volume is divided into subregions, where the outermost boxes are a different material. The materials by default are water and boron as these have large scattering cross-sections for neutrons (the default particle).</p>
<h1><a class="anchor" id="ThreadsafeScorers_s3"></a>
PHYSICS LIST</h1>
<p>The particle's type and the physic processes which will be available in this example are set are built from a variety of physics constructors. The chosen physics lists are extensive, primarily The constructors are:</p>
<ul>
<li><a class="el" href="../../de/d99/classG4EmStandardPhysics__option4.html">G4EmStandardPhysics_option4</a></li>
<li><a class="el" href="../../d9/d5f/classG4DecayPhysics.html">G4DecayPhysics</a></li>
<li><a class="el" href="../../db/d82/classG4RadioactiveDecayPhysics.html">G4RadioactiveDecayPhysics</a></li>
<li><a class="el" href="../../d9/d63/classG4HadronPhysicsQGSP__BERT__HP.html">G4HadronPhysicsQGSP_BERT_HP</a></li>
<li><a class="el" href="../../d1/db1/classG4HadronElasticPhysicsHP.html">G4HadronElasticPhysicsHP</a></li>
<li><a class="el" href="../../dd/d40/classG4StepLimiterPhysics.html">G4StepLimiterPhysics</a></li>
<li><a class="el" href="../../de/d36/classG4IonElasticPhysics.html">G4IonElasticPhysics</a></li>
<li><a class="el" href="../../dc/de5/classG4IonBinaryCascadePhysics.html">G4IonBinaryCascadePhysics</a></li>
</ul>
<h1><a class="anchor" id="ThreadsafeScorers_s4"></a>
ACTION INITALIZATION</h1>
<p><a class="el" href="../../d2/d24/classTSActionInitialization.html" title="Standard ActionInitialization class creating a RunAction instance for the master thread and RunAction...">TSActionInitialization</a>, instantiates and registers to Geant4 kernel all user action classes.</p>
<p>While in sequential mode the action classes are instatiated just once, via invoking the method: <a class="el" href="../../d2/d24/classTSActionInitialization.html#a1192a52e813462a615373ffc327ce752">TSActionInitialization::Build()</a> in multi-threading mode the same method is invoked for each thread worker and so all user action classes are defined thread-local.</p>
<p>A run action class is instantiated both thread-local and global that's why its instance is created also in the method <a class="el" href="../../d2/d24/classTSActionInitialization.html#aafb002a7223f00cfb254dcc65b6dd143">TSActionInitialization::BuildForMaster()</a> which is invoked only in multi-threading mode.</p>
<h1><a class="anchor" id="ThreadsafeScorers_s5"></a>
PRIMARY GENERATOR</h1>
<p>The primary generator is defined in the <a class="el" href="../../d2/d8a/classTSPrimaryGeneratorAction.html">TSPrimaryGeneratorAction</a> class. The default kinematics is a 1 MeV neutron, randomly distributed in front of the target across 100% of the transverse (X,Y) target size. This default setting can be changed via the Geant4 built-in commands of the <a class="el" href="../../dc/ded/classG4ParticleGun.html">G4ParticleGun</a> class.</p>
<h1><a class="anchor" id="ThreadsafeScorers_s6"></a>
DETECTOR RESPONSE</h1>
<p>This example demonstrates a scoring implemented in the user action classes and <a class="el" href="../../da/d74/classTSRun.html">TSRun</a> object.</p>
<p>The energy deposited is collected per event in the PrimitiveScorer <a class="el" href="../../de/d64/classG4PSEnergyDeposit.html">G4PSEnergyDeposit</a> (as part of a MultiFunctionalDetector) and the thread-local version are merged at the end of the run.</p>
<p>The number of steps is collected per event in the PrimativeScorer G4PSNoOfSteps and the thread-local version are merged at the end of the run.</p>
<p>When the MFD is recording an event i.e. <a class="el" href="../../da/d74/classTSRun.html#a99bf10381b869b4b377eddaf6d91e363">TSRun::RecordEvent(const G4Event*)</a>, the global atomic hits map adds the same hits collections</p>
<p>In multi-threading mode the energy accumulated in <a class="el" href="../../da/d74/classTSRun.html">TSRun</a> MFD object per workers is merged to the master in <a class="el" href="../../da/d74/classTSRun.html#a4498b22c0a9d17eea24e156b16779353">TSRun::Merge()</a>.</p>
<p>Scoring is accumulated with thread-local doubles, thread-global atomics, mutex-locking, <a class="el" href="../../da/df3/classG4StatAnalysis.html">G4StatAnalysis</a>, and <a class="el" href="../../d2/dae/classG4ConvergenceTester.html">G4ConvergenceTester</a></p>
<p><a class="el" href="../../da/d74/classTSRun.html">TSRun</a> contains five hits collections types: 1) a thread-local hits map, 2) a global atomic hits map 3) a global "mutex" hits map 4) a global <a class="el" href="../../da/df3/classG4StatAnalysis.html">G4StatAnalysis</a> hits deque 5) a global <a class="el" href="../../d2/dae/classG4ConvergenceTester.html">G4ConvergenceTester</a> hits deque</p>
<p>The thread-local hits map is the same as you will find in many other examples.</p>
<p>The atomics hits map is the purpose of this example. Code-wise, the implementation looks extremely similar to the thread-local version with 3 primary exceptions: (1) construction - there should only be one instance so it should be a static member variable or a pointer/reference to a single instance (2) It does not need to, nor should be, summed in <a class="el" href="../../d2/d10/classG4Run.html#a83fad19c4a64f0e0888743b3063eaba8">G4Run::Merge()</a> (3) destruction &ndash; it should only be cleared by the master thread since there is only one instance.</p>
<p>The "mutex" hits map is also included as reference for checking the results accumulated by the thread-local hits maps and atomic hits maps. The differences w.r.t. this hits maps are computed in <a class="el" href="../../d6/d56/classTSRunAction.html#a1b80e90970cf13fbf75bb287993414cd">TSRunAction::EndOfRunAction</a></p>
<p>The "G4StatAnalysis" and "G4ConvergenceTester" hits deques are memory-efficient version of the standard <a class="el" href="../../d7/d42/classG4THitsMap.html">G4THitsMap</a>. While maps are ideal for scoring at the G4Event-level, where sparsity w.r.t. indices is common; at the G4Run-level, these data structures require much less memory overhead. Due to a lack of G4ConvergenceTester::operator+=(G4ConvergenceTester), the static version of <a class="el" href="../../d2/dae/classG4ConvergenceTester.html">G4ConvergenceTester</a> is the only valid way to use <a class="el" href="../../d2/dae/classG4ConvergenceTester.html">G4ConvergenceTester</a> in a scoring container. This is not the case for <a class="el" href="../../da/df3/classG4StatAnalysis.html">G4StatAnalysis</a>, which can be used in lieu of G4double.</p>
<h1><a class="anchor" id="ThreadsafeScorers_s7"></a>
HOW TO RUN</h1>
<ul>
<li><p class="startli">Execute ts_scorers in the 'interactive mode' with visualization: </p><pre class="fragment">% ./ts_scorers
</pre><p class="startli">and type in the commands from run.mac line by line: </p><pre class="fragment">Idle&gt; /control/verbose 2
Idle&gt; /tracking/verbose 1
Idle&gt; /run/beamOn 10 
Idle&gt; ...
Idle&gt; exit
</pre><p class="startli">or </p><pre class="fragment">Idle&gt; /control/execute run.mac
....
Idle&gt; exit
</pre></li>
<li>Execute ts_scorers in the 'batch' mode from macro files (without visualization) <pre class="fragment">% ./ts_scorers run.mac
% ./ts_scorers run.mac &gt; run.out
</pre></li>
</ul>
<h1><a class="anchor" id="ThreadsafeScorers_s8"></a>
TIMEMORY USAGE</h1>
<pre class="fragment">This example demonstrates timing and memory analysis with TiMemory
(https://github.com/jrmadsen/TiMemory).

- Compile Geant4 with TiMemory (-DGEANT4_USE_TIMEMORY=ON)
- TiMemory auto-timer provide timing within the Geant4 source code
  and within the example (TSRun::RecordEvent)
- Analysis is echoed to stdout, recorded in ts_scorers.out, and
  serialized in ts_scorers.json
- Generates plots:
  "timemory-plotter -f ts_scorers.json -t "ThreadSafe Scorers" -o plots -e"
- Uploads plots to CDash if enabled
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.16
</small></address>
</body>
</html>
