<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Geant4: Example field04</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Geant4
   &#160;<span id="projectnumber">10.05.p01</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Example field04 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This example shows how to define/use OVERLAPPING field elements in Geant4. Fields might be either magnetic, electric or both.</p>
<p>Credit goes to Tom Roberts and Muons Inc. since much of the code and ideas were taken at liberty from the (GNU GPL) source of G4BEAMLINE release 1.12.</p>
<p><a href="http://g4beamline.muonsinc.com">http://g4beamline.muonsinc.com</a></p>
<h1><a class="anchor" id="field04_s1"></a>
Classes</h1>
<h2><a class="anchor" id="field04_sub_s11"></a>
main ()</h2>
<p>See <a class="el" href="../../d1/d9f/field04_8cc.html" title="Main program of the field/field04 example.">field04.cc</a>.</p>
<p>The example can be run with the following optional arguments:</p>
<pre class="fragment">% field04 [-m macro ] [-p physicsList] [-r randomSeed] [-s preinit|idle]   
</pre><p>If a macro is provided with the option "-m", the program runs in a batch mode, otherwise the program open the interactive session after executing the default initialization macro init_vis.mac. The option "-s preinit" can be used to start the program without initialization in PreInit phase.</p>
<p>For example: to assign the <a class="el" href="../../d0/ddf/classF04PhysicsList.html">F04PhysicsList</a>: </p><pre class="fragment">% field04 -p QGSP_BERT
</pre><p>an initial random number seed with: </p><pre class="fragment">% field04 field04.in -r 12345
</pre><p>to start with a macro file and an initial seed: </p><pre class="fragment">% field04 -m field04.in -r 12345
</pre><h2><a class="anchor" id="field04_sub_s12"></a>
F04DetectorConstruction</h2>
<p>The geometry consists of two solenoidal magnets: a "CaptureMgnt" followed by a (blue-colored "TransferMgnt". By definition, the axis and center of the "CaptureMgnt" coincide with the "World". The position of the "TransferMgnt" relative to the downstream end of the "CaptureMgnt", as well as its axis angle, both may vary. A cylindrical "Target" is positioned inside the "CaptureMgnt". Its axis can vary from 0 to 180 deg, and hence also the direction of the incoming proton beam wrt the "CaptureMgnt"'s axis. A "Degrader" is located inside the "TransferMgnt", its default position being at the upstream end of the "TransferMgnt". Finally, also a "TestPlane" is located inside the "TransferMgnt", by default at its downstream end.</p>
<p>The "World" consists of a solid cylinder made of a given material. (It is the responsibility of the user to make the world large enough to contain the rest of the geometry!)</p>
<p>Three parameters define the world :</p><ul>
<li>the material of the world,</li>
<li>the world radius,</li>
<li>the world length.</li>
</ul>
<p>Example (default values): </p><pre class="fragment">/field04/SetWorldMat G4_AIR
/field04/SetWorldR  5.0 m
/field04/SetWorldZ 50.0 m
</pre><p>The "Target" is a solid cylinder made of a given material. Five parameters define the target:</p><ul>
<li>the material of the target,</li>
<li>the target radius,</li>
<li>the target thickness,</li>
<li>the target position inside the "CaptureMgnt",</li>
<li>the target axis angle relative to that of the "CaptureMgnt".</li>
</ul>
<p>Example (default values): </p><pre class="fragment">/field04/SetTgtMat G4_W
/field04/SetTgtRad    0.4 cm
/field04/SetTgtThick 16.0 cm
/field04/SetTgtPos 0.0 cm
/field04/SetTgtAng 170
</pre><p>The "Degrader" is a solid cylinder made of a given material.</p>
<p>Four parameters define the degrader:</p><ul>
<li>the material of the degrader,</li>
<li>the degrader radius,</li>
<li>the degrader thickness,</li>
<li>the degrader position relative to the "TransferMgnt" center.</li>
</ul>
<p>Example (default values): </p><pre class="fragment">/field04/SetDgrMat G4_Pb
/field04/SetDgrRad  30.0 cm
/field04/SetDgrThick 0.1 cm
#/field04/SetDgrPos -7.4 m
</pre><p>The "CaptureMgnt" is a solenoid (vacuum cylinder). It is either a two-sided or a one-sided magnetic bottle with the B field varying linearly from the center value B1 to the edge value B2. The one-sided <a class="el" href="../../d5/d4f/classF04FocusSolenoid.html">F04FocusSolenoid</a> has the open end at +z and focuses on the z &lt; 0 side.</p>
<p>Four parameters define the "CaptureMgnt":</p><ul>
<li>the magnet radius,</li>
<li>the magnet length,</li>
<li>the weaker magnetic field at the center B1</li>
<li>the stronger magnetic field at the edge B2</li>
</ul>
<p>Example (default values): </p><pre class="fragment">/field04/SetCaptureR 0.6 m 
/field04/SetCaptureZ 4.0 m
/field/SetCaptureB1 2.5 tesla 
/field/SetCaptureB2 5.0 tesla
</pre><p>The "TransferMgnt" is a solenoid (vacuum cylinder) with a constant B-field. When the "TransferMgnt" follows immediately the "CaptureMgnt", its relative position is at 0 cm.</p>
<p>Four parameters define the "TransferMgnt":</p><ul>
<li>the magnet radius,</li>
<li>the magnet length,</li>
<li>the magnet field,</li>
<li>the magnet relative position (its upstream face wrt the downstream face of the "CaptureMgnt".)</li>
</ul>
<p>Example (default values): </p><pre class="fragment">/field04/SetTransferR  0.3 m
/field04/SetTransferZ 15.0 m
/field/SetTransferB 5.0 tesla
/field04/SetTransferP 0.0 m
</pre><p> The default geometry is constructed in <a class="el" href="../../d5/d42/classF04DetectorConstruction.html">F04DetectorConstruction</a> class, but all the parameters can be changed via the commands defined in the <a class="el" href="../../d6/d01/classF04DetectorMessenger.html">F04DetectorMessenger</a> class.</p>
<h2><a class="anchor" id="field04_sub_s13"></a>
F04Materials</h2>
<p>Material definitions are done through the singleton class <a class="el" href="../../d4/d5a/classF04Materials.html">F04Materials</a> which keeps a pointer to the <a class="el" href="../../d2/d00/classG4NistManager.html">G4NistManager</a>. It has a method GetMaterial by name (<a class="el" href="../../d5/d72/classG4String.html">G4String</a>) which in turn invokes the <a class="el" href="../../d2/d00/classG4NistManager.html#abb3a53647400f8477dfe1cae931c3e72">G4NistManager::FindOrBuildMaterial</a>, and/or <a class="el" href="../../d5/de4/classG4Material.html#ae03e012341ce72383a9b363693785bb8">G4Material::GetMaterial</a> methods. It has also a method CreateMaterials which, for materials absent from the NIST data base, shows how to create them using the <a class="el" href="../../d2/d00/classG4NistManager.html#ab2de129709586652e4b018f61603a2e9">G4NistManager::ConstructNewMaterial</a> method.</p>
<h2><a class="anchor" id="field04_sub_s14"></a>
F04PrimaryGeneratorAction</h2>
<p>The primary kinematic consists of a single particle which hits the target perpendicular to its upstream face. The type of the particle and its energy are set in the <a class="el" href="../../dd/d3d/classF04PrimaryGeneratorAction.html">F04PrimaryGeneratorAction</a> class, and can be changed via the G4 build-in commands of the <a class="el" href="../../dc/ded/classG4ParticleGun.html">G4ParticleGun</a> class. In addition, there is a fRndmFlag, which once set allows the beam to explore randomly the whole cross section of the target. The default beam consists of 500 MeV protons, starting at the upstream face of the target, directed along dx = dy = 0, dz = 1 wrt the target frame. The default direction should NOT be changed! The arguments of the x/y/zvertex commands are relative to the target center.</p>
<p>Example: </p><pre class="fragment">/gun/random on
#/gun/xvertex 0 mm
#/gun/yvertex 0 mm
#/gun/zvertex -100 mm
</pre><h2><a class="anchor" id="field04_sub_s15"></a>
DETECTOR RESPONSE in F04SteppingAction</h2>
<p>Information is extracted from the program via <a class="el" href="../../de/d98/classF04SteppingAction.html">F04SteppingAction</a> at the TestPlane.</p>
<h2><a class="anchor" id="field04_sub_s16"></a>
F04PhysicsList</h2>
<p>The <a class="el" href="../../d0/ddf/classF04PhysicsList.html">F04PhysicsList</a> extends a selected Geant4 physics list. The base physics list name is provided by its name in the <a class="el" href="../../d0/ddf/classF04PhysicsList.html">F04PhysicsList</a> constructor.</p>
<p>In addition to processes defined in the base Geant4 physics list, there is added the <a class="el" href="../../d3/d5d/classF04StepMax.html">F04StepMax</a> process and the decay of pions can be assigned via dedicated commands in <a class="el" href="../../dd/d9b/classF04PhysicsListMessenger.html" title="Provide control of the physics list and cut parameters.">F04PhysicsListMessenger</a>.</p>
<p>The command to define maximum step: </p><pre class="fragment">/exp/phys/stepMax value unit
</pre><p>The decay of pions can be assigned via (pi -&gt; e nu, pi -&gt; mu nu): </p><pre class="fragment">/decay/pienu
/decay/pimunu
</pre><p>The pienu assignment includes a small fraction of radiative decay: e nu gamma (<a class="el" href="../../d6/dc8/classG4PionRadiativeDecayChannel.html">G4PionRadiativeDecayChannel</a>).</p>
<p>The standard/default muon decay chain is modified to be 98.6% <a class="el" href="../../d4/de4/classG4MuonDecayChannelWithSpin.html">G4MuonDecayChannelWithSpin</a> and 1.4% <a class="el" href="../../df/de5/classG4MuonRadiativeDecayChannelWithSpin.html">G4MuonRadiativeDecayChannelWithSpin</a> in ConstructParticle().</p>
<p>The pion decay process G4PolDecay inherits from <a class="el" href="../../dc/deb/classG4Decay.html">G4Decay</a> and implements the virtual method - empty in the base class - DaughterPolarization</p>
<p>The muon decay process is <a class="el" href="../../dc/d66/classG4DecayWithSpin.html">G4DecayWithSpin</a></p>
<p>Furthermore, the following commands are also available, but may only be used AFTER /run/initialize</p>
<pre class="fragment">/process/inactivate msc
/process/activate msc
</pre><h2><a class="anchor" id="field04_sub_s17"></a>
Overlapping Fields</h2>
<p>The <a class="el" href="../../df/de8/classF04GlobalField.html">F04GlobalField</a> (a singleton) is instantiated in <a class="el" href="../../d5/d42/classF04DetectorConstruction.html">F04DetectorConstruction()</a> and assigned to the global field manager in UpdateField(): </p><pre class="fragment">fFieldManager = GetGlobalFieldManager();
fFieldManager-&gt;SetDetectorField(this);
</pre><p> The <a class="el" href="../../df/de8/classF04GlobalField.html">F04GlobalField</a> has a std::vector&lt;ElementField*&gt; FieldList</p>
<p>The field from each individual beamline element is given by a <a class="el" href="../../d0/d37/classF04ElementField.html">F04ElementField</a> object. Any number of overlapping <a class="el" href="../../d0/d37/classF04ElementField.html">F04ElementField</a> objects can be added to the <a class="el" href="../../df/de8/classF04GlobalField.html">F04GlobalField</a>. Any element that represents an element with an EM field must add the appropriate <a class="el" href="../../d0/d37/classF04ElementField.html">F04ElementField</a> to the global <a class="el" href="../../df/de8/classF04GlobalField.html">F04GlobalField</a> object.</p>
<p>Of course, the <a class="el" href="../../df/de8/classF04GlobalField.html">F04GlobalField</a> has the method GetFieldValue implemented.</p>
<p>Before /run/initialize in the macro file or command, the update field command must have been issued if any of the other following field commands was employed: </p><pre class="fragment">/field/update
</pre><p>Other options are: </p><pre class="fragment">/field/setStepperType 4
/field/setMinStep 10 mm
/field/setDeltaChord 3.0 mm
/field/setDeltaOneStep 0.01 mm
/field/setDeltaIntersection 0.1 mm
/field/setEpsMin 2.5e-7 mm
/field/setEpsMax 0.05 mm
</pre><p> Each field element has a rectilinear bounding box in global coordinate space which is checked before a point is verified to actually be inside the <a class="el" href="../../d0/d37/classF04ElementField.html">F04ElementField</a> (IsWithin and IsOutside). SetGlobalPoint is called 8 times for the corners of the local bounding box, after a local-&gt;global coordinate transform.</p>
<p>The <a class="el" href="../../d0/d37/classF04ElementField.html">F04ElementField</a> is the interface class used by <a class="el" href="../../df/de8/classF04GlobalField.html">F04GlobalField</a> to compute the field value at a given point[].</p>
<p>A beamline element, for example the <a class="el" href="../../da/d78/classF04SimpleSolenoid.html">F04SimpleSolenoid</a>, will derive from <a class="el" href="../../d0/d37/classF04ElementField.html">F04ElementField</a> and implement the computation for the element. </p><pre class="fragment">simpleSolenoid 
  = new F04SimpleSolenoid(B, l, logicTransferMgnt,TransferMgntCenter);
</pre><p> Besides the magnetic field and the length of the simple solenoid, the constructor needs the knowledge of the <a class="el" href="../../da/dc4/classG4LogicalVolume.html">G4LogicalVolume</a> for the beamline element and where its center is located in the 'World'.</p>
<p>The <a class="el" href="../../d0/d37/classF04ElementField.html">F04ElementField</a> has a <a class="el" href="../../d8/d1e/classG4AffineTransform.html">G4AffineTransform</a> "fGlobal2local" which allows the quick computation of coordinate transformations. It can only be determined by knowing the element's coordinate origin in the global frame and after all of the geometry has been defined. For this reason, the object is prepared in two stages, through the constructor providing it with the coordinate center and a pointer to the <a class="el" href="../../da/dc4/classG4LogicalVolume.html">G4LogicalVolume</a>. Later the <a class="el" href="../../d1/d8a/namespacepyExN03geom.html#a0dad4872b56e32fad4c28deeb4dc252c">Construct()</a> method is called to calculate the fGlobal2local and the bounding box. This can be done from the <a class="el" href="../../df/da5/classF04RunAction.html#a97bc9e4024e86796aca1716b119df15e">F04RunAction::BeginOfRunAction</a> method, for only then are we certain that the geometry has been completely built: </p><pre class="fragment">FieldList* fields = F04GlobalField::GetObject()-&gt;GetFields();

if (fields) {
   if (fields-&gt;size()&gt;0) {
      FieldList::iterator i;
      for (i=fields-&gt;begin(); i!=fields-&gt;end(); ++i)(*i)-&gt;Construct();
   }
}
</pre><p> The <a class="el" href="../../d0/d37/classF04ElementField.html">F04ElementField</a> constructor will also add the derived object into <a class="el" href="../../df/de8/classF04GlobalField.html">F04GlobalField</a>. Finally, its AddFieldValue() will add the field value for this element to field[].</p>
<h2><a class="anchor" id="field04_sub_s18"></a>
User Action Classes</h2>
<ul>
<li><a class="el" href="../../d9/d25/classF04RunActionMessenger.html">F04RunActionMessenger</a>: <pre class="fragment">/rndm/save freq - to save rndm status in external files
 0 not saved
       &gt;0 saved on: beginOfRun.rndm
 1 saved on:   endOfRun.rndm
 2 saved on: endOfEvent.rndm
/rndm/read random/run0evt8268.rndm
</pre></li>
<li><a class="el" href="../../df/da5/classF04RunAction.html">F04RunAction</a>: <br  />
 <br  />
 BeginOfRunAction: Deal with random number storage, initialization etc. <a class="el" href="../../d6/d3d/classCall.html">Call</a> the <a class="el" href="../../d1/d8a/namespacepyExN03geom.html#a0dad4872b56e32fad4c28deeb4dc252c">Construct()</a> method of F04ElementFields in the FieldList of <a class="el" href="../../df/de8/classF04GlobalField.html">F04GlobalField</a> object. EndOfRunAction: random number storage/status printing.</li>
<li><a class="el" href="../../d8/d39/classF04EventActionMessenger.html">F04EventActionMessenger</a>: <br  />
 <pre class="fragment">/event/setverbose
</pre></li>
<li><a class="el" href="../../d4/d03/classF04EventAction.html">F04EventAction(F04RunAction* RA)</a>: <br  />
 Customized BeginOfEvent printing EndofEvent: saveEngingStatus and showEngineStatus according to flag in <a class="el" href="../../df/da5/classF04RunAction.html">F04RunAction</a></li>
<li><a class="el" href="../../d2/de9/classF04TrackingAction.html">F04TrackingAction</a>: <br  />
 PreUserTrackingAction: Instantiate <a class="el" href="../../d4/daf/classF04UserTrackInformation.html">F04UserTrackInformation</a> and set the application TrackStatus. PostUserTrackingAction: Retreive <a class="el" href="../../d4/daf/classF04UserTrackInformation.html">F04UserTrackInformation</a> and decide to save random number status accordingly.</li>
<li><a class="el" href="../../dc/d7e/classF04SteppingActionMessenger.html">F04SteppingActionMessenger</a>: <br  />
</li>
<li><a class="el" href="../../de/d98/classF04SteppingAction.html">F04SteppingAction</a>: <br  />
 UserSteppingAction: Kill primary if/when outside Target volume. Diagnostic/histogram filling for particles at a TestPlane. Find decay position and when particle FIRST reverses z-momentum component via using a <a class="el" href="../../d4/daf/classF04UserTrackInformation.html">F04UserTrackInformation</a> object.</li>
<li><a class="el" href="../../d1/d74/classF04StackingAction.html">F04StackingAction</a>: <br  />
 <a class="el" href="../../d9/d18/classTrack.html">Track</a> only primaries, pi+ or mu+</li>
<li><a class="el" href="../../d4/daf/classF04UserTrackInformation.html">F04UserTrackInformation</a>: <br  />
 Keep an application F04TrackStatus for the track: <br  />
 undefined, left, right, reverse</li>
<li><a class="el" href="../../d4/d9a/classF04SteppingVerbose.html">F04SteppingVerbose</a>: <br  />
 Only print track header and step information for pi+ and mu+. Note: the information for primary protons is not printed.</li>
<li><a class="el" href="../../d9/dd2/classF04Trajectory.html">F04Trajectory</a>, <a class="el" href="../../d8/dbe/classF04TrajectoryPoint.html">F04TrajectoryPoint</a>: <br  />
 Example of application specific implementations</li>
</ul>
<h1><a class="anchor" id="field04_s2"></a>
HOW TO START ?</h1>
<ul>
<li>Execute field04 in 'batch' mode from macro files e.g. <pre class="fragment">% field04 -m field04.in
</pre></li>
<li>Execute field04 in 'interactive' mode with visualization <pre class="fragment">% field04
....
Idle&gt; type your commands
....
</pre></li>
<li>Execute field04 in 'interactive' mode without initialization <pre class="fragment">% field04 -s preinit
....
Idle&gt; type your commands, then
Idle&gt; /run/initialize
Idle&gt; /control/execute vis.mac
....
</pre> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.16
</small></address>
</body>
</html>
