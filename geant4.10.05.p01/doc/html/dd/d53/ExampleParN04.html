<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Geant4: Example ParN04</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Geant4
   &#160;<span id="projectnumber">10.05.p01</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Example ParN04 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>ParGeant4: Geant4/TOP-C, a parallelization of Geant4 (event-level parallelism)</p>
<dl class="section author"><dt>Author</dt><dd>Gene Cooperman, Northeastern University, <a href="#" onclick="location.href='mai'+'lto:'+'gen'+'e@'+'ccs'+'.n'+'eu.'+'ed'+'u'; return false;">gene@<span style="display: none;">.nosp@m.</span>ccs.<span style="display: none;">.nosp@m.</span>neu.e<span style="display: none;">.nosp@m.</span>du</a></dd></dl>
<p>For the latest information on ParGeant4, see: <br  />
 <a href="http://www.ccs.neu.edu/home/gene/pargeant4.html">http://www.ccs.neu.edu/home/gene/pargeant4.html</a></p>
<p>Note that a version now exists that runs Geant4 over the Grid. Please write to <a href="#" onclick="location.href='mai'+'lto:'+'gen'+'e@'+'ccs'+'.n'+'eu.'+'ed'+'u'; return false;">gene@<span style="display: none;">.nosp@m.</span>ccs.<span style="display: none;">.nosp@m.</span>neu.e<span style="display: none;">.nosp@m.</span>du</a> for further information. To port other applications to a parallel version, read the files ../../info/PAR_INSTALL and ../../info/PAR_README.</p>
<hr  />
<p>See the beginning of GNUmakefile for reasonable &lsquo;make&rsquo; targets to run it. To run it: <br  />
</p><ol type="1">
<li><ul>
<li>a. Follow the standard Geant4 installation procedure.</li>
<li>b. Download and install TOP-C. <br  />
 The TOP-C home page is at <a href="http://www.ccs.neu.edu/home/gene/topc.html">http://www.ccs.neu.edu/home/gene/topc.html</a> <pre class="fragment">cd &lt;TOPC_INSTALL_DIR&gt;
gzip -dc topc.tar.gz | tar -xvf -
cd topc
./configure
make
make check
[ Copy bin/topc-config to your path ]
</pre></li>
<li>c. Verify that the Geant4 example installs: <pre class="fragment">cd $G4INSTALL/examples/extended/parallel/ParN04
make
$G4WORKDIR/bin/$G4SYSTEM/ParN04 ParN04.in
</pre> <br  />
</li>
</ul>
</li>
<li><pre class="fragment">make run
</pre> <br  />
 [ By default, the included &lsquo;procgroup&rsquo; file creates two slave processes on localhost. ] <br  />
 [ Note that in addition to output on master, $G4WORKDIR/bin/$G4SYSTEM/slave*.out contains slave output. ]<br  />
 [ To remove intermediate files and start over: make parclean ] <br  />
</li>
<li><br  />
 Try running it with slave processes on remote processes. First, test that your local environment is set up correctly. Try: <pre class="fragment">ssh &lt;REMOTE_HOSTNAME&gt; $G4WORKDIR/bin/$G4SYSTEM/ParN04 `pwd`/ParN04.in
</pre> <br  />
 The above command needs to work without asking for a password. [ If you use dynamic libraries (*.so), make sure the LD_LIBRARY_PATH in your shell startup file (e.g. ~.tcshrc) includes both: $G4INSTALL/lib/$G4SYSTEM and $CLHEP_BASE_DIR/lib If you use AFS, you may need to type 'klog' to renew your AFS token. ] In &lsquo;procgroup&rsquo; file, replace &lsquo;localhost&rsquo; by desired remote hosts; Add additional remote hosts (additional slaves) if you like. <br  />
 Then: <br  />
 <pre class="fragment">make run 
</pre> <br  />
</li>
</ol>
<hr  />
<p>If you read ParGNUmakefile, you'll find other things that you can modify. <br  />
</p><ul>
<li>For example, all TOP-C additions are in conditionals: remove -DG4USE_TOPC from ParGNUmakefile and: <pre class="fragment">make parclean; make run
</pre> in order to re-compile and rerun without TOP-C.</li>
<li>Define REMOTE_SHELL differently if you don't use &lsquo;ssh&rsquo; for a remote shell. (If undefined, ParGNUmakefile defines it to be &lsquo;ssh&rsquo;)</li>
<li>Define MACROFILE diferently to use a different set of input commands.</li>
<li>Define MEM_MODEL=&ndash;seq to run with TOP-C, but using a single (sequential) process, suitable for easy debugging (via gdb, for example).</li>
<li>Try: pushd $G4WORKDIR/bin/$G4SYSTEM/; ./ParN04 &ndash;TOPC-help to see TOP-C run-time options that can be invoked, such as pushd $G4WORKDIR/bin/$G4SYSTEM/; ./ParN04 &ndash;TOPC-num-slaves=5 ParN04.in</li>
<li>Alternatively, modify TOPC_OPTIONS in ParGNUmakefile for the same effect.</li>
</ul>
<p>You can also try other targets: make run-debug This will run it under gdb, so you can single step to see what happens. make parclean - Start over with clean set of files.</p>
<hr  />
<p>New or modified files:</p><ul>
<li><a class="el" href="../../da/d6e/ParN04_8cc.html">ParN04.cc</a> - Adds one line: #include "ParN04.icc" ParExample.icc inserts: #include "topc.h" and causes main to calls TOPC_init, TOPC_finalize, and to use: &lsquo;new <a class="el" href="../../d5/d85/classParRunManager.html">ParRunManager</a>&rsquo; instead of &lsquo;new <a class="el" href="../../d4/daa/classG4RunManager.html">G4RunManager</a>&rsquo;</li>
<li>GNUmakefile - Adds one line at beginning: include ParGNUmakefile ParGNUmakefile defines EXTRALIBS and CPPFLAGS so as to modify behavior of config/binmake.gmk in order to use TOP-C libraries and includes</li>
<li>procgroup - Specifies which slave hosts to use, and where to put output For example: localhost 1 - &gt; slave1.out host=&lsquo;localhost&rsquo;, executable=&lsquo;same as master&rsquo;, params of slave=&lsquo;&gt; slave1.out&rsquo; (redirect output) If output not redirected, it goes to stdout on master.</li>
<li>src/ParRunManager.cc - ParRunManger derived from <a class="el" href="../../d4/daa/classG4RunManager.html">G4RunManager</a> replaces Gr4RunManager::DoEventLoop w/ TOP-C parallel loop, Adds certain local vars of DoEventLoop as <a class="el" href="../../d5/d85/classParRunManager.html">ParRunManager</a> members</li>
<li>include/MarshaledObj.h - run-time utilities for marshalling</li>
<li>include/MarshaledEx*Hit.h - marshals N04 hits (calorimeter hits)</li>
<li>include/MarshaledG4*.h - marshaling routines for Geant4 data structures</li>
<li>~/slave*.out - Contains outputs of slave1, slave2, etc. Generated each time parallel ParN04 is executed. These files are specified in the file procgroup.</li>
</ul>
<hr  />
<p>This version passes an event number to the slave and lets the slave generate the event. The slave passes back marshaled hits to the master.</p>
<p>I will integrate the track level parallelism into this scenario at a later date. For the track level, I will generate several secondary tracks on the master, and then convert the secondary tracks to new events that can be passed to slaves. I will do this only if I detect that there are not enough initial events to fully occupy all the slaves. This scheme has the drawback that we are splitting an event into many events, which may make the summarization, histogram, and so on more difficult. However, track level parallelism will be triggered only when a very small number of events are generated.</p>
<p>I also want to support postponing a track to the next event ( G4ClassificationOfNewTrack::fPostpone . To do this, each slave will wait to retire an event until it knows that the previous event has been retired.</p>
<p>In addition, I plan to have only the master read commands and pass them to the slaves. Currently, the master and slaves each read identical commands.</p>
<hr  />
<p>If you are curious about some of the layers, the following stack trace [somewhat out of date now] gives some idea.</p><ul>
<li><a class="el" href="../../d4/daa/classG4RunManager.html#a2e8622295d194ab03d48a9447c22521c">G4RunManager::BeamOn</a> calls <a class="el" href="../../d5/d85/classParRunManager.html#ab656293f728f5c138dae697c689840b1">ParRunManager::DoEventLoop</a> (since <a class="el" href="../../d4/daa/classG4RunManager.html#a34ac7c964ca9fb147645f1a942dd449f">G4RunManager::DoEventLoop</a> is virtual)</li>
<li><a class="el" href="../../d5/d85/classParRunManager.html#ab656293f728f5c138dae697c689840b1">ParRunManager::DoEventLoop</a> calls TOPC_master_slave</li>
<li>TOPC_master_slave calls submit_task_input</li>
<li>submit_task_input eventually calls COMM_send_msg which calls MPI_Send (COMM_send_msg is the communication layer of TOPC; <a class="el" href="../../da/d6e/ParN04_8cc.html">ParN04.cc</a> was linked with the TOP-C MPI communication layer. The same source could have been linked with a POSIX threads layer, a communication layer, or some other communication layer. )</li>
<li>MPI_send calls send (where send is the socket system call of libc.so) <pre>
(gdb) where
#0  0x41946c62 in send () from /lib/libc.so.6
#1  0x400839c1 in send () at wrapsyscall.c:186
#2  0x805c547 in MPI_Send (buf=0x82690fc, count=4, datatype=3, dest=2, tag=1, comm=0) at sendrecv.c:236
#3  0x805a0b5 in COMM_send_msg (msg=0x82690fc, msg_size=4, dst=2, tag=TASK_INPUT_TAG) at comm-mpi.c:224
#4  0x805774e in send_task_input (slave=2, input={data = 0x82690fc, data_size = 4}, tag=TASK_INPUT_TAG) at topc.c:560
#5  0x8057aa8 in submit_task_input (input={data = 0x82690fc, data_size = 4}) at topc.c:659
#6  0x805813c in TOPC_master_slave (generate_task_input_=0x4003d2e4 &lt;<a class="el" href="../../d5/d85/classParRunManager.html#aa6788d22dc75167dd9aa20f43a57b3a2">ParRunManager::GenerateEventInput(void)</a>&gt;, 
    do_task_=0x4003d350 &lt;ParRunManager::DoEvent(int *)&gt;, check_task_result_=0x4003d420 &lt;ParRunManager::CheckEventResult(int *, void *)&gt;, 
    update_shared_data_=0) at topc.c:922
#7  0x4003d18c in <a class="el" href="../../d5/d85/classParRunManager.html#ab656293f728f5c138dae697c689840b1">ParRunManager::DoEventLoop</a> (this=0x80c0bf0, n_event=1, macroFile=0x0, n_select=-1) at src/ParRunManager.cc:51
#8  0x400b14d1 in <a class="el" href="../../d4/daa/classG4RunManager.html#a2e8622295d194ab03d48a9447c22521c">G4RunManager::BeamOn</a> () from /afs/cern.ch/user/c/cooperma/scratch-pcitapi07/geant4/lib/libG4run.so
#9  0x400b870a in <a class="el" href="../../d7/dcf/classG4RunMessenger.html#aeef7c7062232da161237e3642a24fbf2">G4RunMessenger::SetNewValue</a> () from /afs/cern.ch/user/c/cooperma/scratch-pcitapi07/geant4/lib/libG4run.so
#10 0x4167157b in <a class="el" href="../../d2/dd2/classG4UIcommand.html#a5d54273a98192b96242d0cb63a5ab860">G4UIcommand::DoIt</a> () from /afs/cern.ch/user/c/cooperma/scratch-pcitapi07/geant4/lib/libG4intercoms.so
#11 0x416810a3 in <a class="el" href="../../d8/def/classG4UImanager.html#a2db8f1909b2b35a3000f97b95c8a9b17">G4UImanager::ApplyCommand</a> () from /afs/cern.ch/user/c/cooperma/scratch-pcitapi07/geant4/lib/libG4intercoms.so
#12 0x805db7e in <a class="el" href="../../d5/de9/classG4UIterminal.html#adce89a2a73fcc6baf24100a24a539013">G4UIterminal::ExecuteCommand</a> () at /afs/cern.ch/sw/lhcxx/specific/redhat61/3.2.0/include/CLHEP/Random/Randomize.h:64
#13 0x805d42d in <a class="el" href="../../d5/de9/classG4UIterminal.html#ac3e2a5e4cfd9ad72ac872864bb3f5563">G4UIterminal::SessionStart</a> () at /afs/cern.ch/sw/lhcxx/specific/redhat61/3.2.0/include/CLHEP/Random/Randomize.h:64
#14 0x8056a3d in main (argc=1, argv=0x80bfa00) at <a class="el" href="../../d3/d76/ParN02_8cc.html">ParN02.cc</a>:98
</pre> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.16
</small></address>
</body>
</html>
